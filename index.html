<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>yuviej</title>
  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --accent: #7dd3fc;
      --danger: #ff5555;
      --muted: #9ca3af;
    }

    * { box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--fg);
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 16px 80px;
      line-height: 1.4;
    }

    h2 {
      margin: 0 0 16px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    textarea, input, button {
      margin: 10px 0;
      width: 100%;
      max-width: 520px;
      font-family: inherit;
    }

    textarea {
      min-height: 84px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #222;
      background: #0b0b0b;
      color: var(--fg);
      resize: vertical;
    }

    .controls {
      width: 100%;
      max-width: 520px;
    }

    .u-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #dropzone {
      width: 100%;
      max-width: 520px;
      margin: 10px 0;
      padding: 16px;
      border: 2px dashed #222;
      border-radius: 14px;
      background: #0b0b0b;
      text-align: center;
      color: var(--muted);
    }

    #dropzone.dragover {
      border-color: var(--accent);
      color: var(--fg);
    }

    #preview, #result {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      width: 100%;
      max-width: 1100px;
      margin-top: 10px;
    }

    .thumb {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: #111;
      border: 1px solid #1f2937;
    }

    .thumb img {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }

    .thumb button {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid #333;
      color: #eee;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 8px;
      cursor: pointer;
    }

    #result img {
      width: 100%;
      height: auto;
      max-height: 720px;
      border-radius: 20px;
      border: 1px solid #1f2937;
    }

    #loadingLabel {
      color: var(--fg);
      display: none;
      font-size: 16px;
      margin: 10px 0;
    }

    #errorLabel {
      color: var(--danger);
      font-size: 16px;
      margin-top: 10px;
      display: none;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .btn {
      max-width: 520px;
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      background: var(--fg);
      color: #000;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border: 1px solid #333;
      border-radius: 999px;
      font-size: 12px;
      color: #ddd;
    }
  </style>
</head>

<body>
  <h2>yuviej</h2>

  <div class="controls">
    <textarea id="prompt" placeholder="Enter your prompt… (describe edits or composition details)"></textarea>
    <input type="file" id="imageInput" accept="image/*" multiple />
    <div id="dropzone">Drag & drop images here (or use the file picker). You can attach multiple images.</div>
    <div class="muted" id="countLabel">No files selected.</div>
  </div>

  <div id="preview"></div>

  <div class="u-row" style="max-width:520px;width:100%;align-items:center;">
    <button class="btn" id="generateBtn">Submit (15 variations)</button>
    <span id="progress" class="pill" style="display:none;">0/15</span>
  </div>

  <div id="loadingLabel">Generating…</div>
  <div id="result"></div>
  <div id="errorLabel"></div>

  <script>
    const ENCODED_KEY = "QUl6YVN5QmVUQ1N1WDltbTdaeTNrSHY0eGk3Z2tSMUhLeXV3TGNF";
    const API_KEY = atob(ENCODED_KEY);
    const MODEL_ID = "gemini-2.5-flash-image";

    const els = {
      input: document.getElementById("imageInput"),
      dropzone: document.getElementById("dropzone"),
      preview: document.getElementById("preview"),
      prompt: document.getElementById("prompt"),
      btn: document.getElementById("generateBtn"),
      loading: document.getElementById("loadingLabel"),
      error: document.getElementById("errorLabel"),
      result: document.getElementById("result"),
      count: document.getElementById("countLabel"),
      progress: document.getElementById("progress")
    };

    let files = [];

    els.input.addEventListener("change", e => {
      files = Array.from(e.target.files || []);
      renderPreview();
    });

    ["dragenter", "dragover"].forEach(evt => {
      els.dropzone.addEventListener(evt, e => {
        e.preventDefault();
        e.stopPropagation();
        els.dropzone.classList.add("dragover");
      });
    });

    ["dragleave", "drop"].forEach(evt => {
      els.dropzone.addEventListener(evt, e => {
        e.preventDefault();
        e.stopPropagation();
        els.dropzone.classList.remove("dragover");
      });
    });

    els.dropzone.addEventListener("drop", e => {
      const dropped = Array.from(e.dataTransfer.files || []).filter(f => f.type.startsWith("image/"));
      files = files.concat(dropped);
      renderPreview();
    });

    function renderPreview() {
      els.preview.innerHTML = "";
      els.count.textContent = files.length
        ? `${files.length} image${files.length > 1 ? "s" : ""} selected`
        : "No files selected.";

      files.forEach((file, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "thumb";
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", () => {
          files.splice(idx, 1);
          renderPreview();
        });
        wrap.appendChild(img);
        wrap.appendChild(removeBtn);
        els.preview.appendChild(wrap);
      });
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          try {
            const b64 = String(fr.result).split(",")[1];
            resolve(b64);
          } catch (e) { reject(e); }
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function buildRequestBody({ prompt, encodedFiles, seed }) {
      const parts = [];
      if (prompt) parts.push({ text: prompt });
      if (encodedFiles?.length) {
        encodedFiles.forEach(({ b64, type }) => {
          parts.push({ inlineData: { mimeType: type, data: b64 } });
        });
      }
      return {
        contents: [{ role: "user", parts }],
        generationConfig: {
          responseModalities: ["IMAGE"],
          temperature: 1.0,
          ...(typeof seed === "number" ? { seed } : {})
        }
      };
    }

    async function callGemini(body) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${API_KEY}`;
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error?.message || JSON.stringify(data));

      const images = [];
      const candidates = data?.candidates || [];
      for (const c of candidates) {
        const parts = c?.content?.parts || [];
        for (const p of parts) {
          if (p?.inlineData?.data) {
            images.push({
              mime: p.inlineData.mimeType || "image/png",
              b64: p.inlineData.data
            });
          }
        }
      }
      return images;
    }

    document.getElementById("generateBtn").addEventListener("click", generateImagesBatch);

    async function generateImagesBatch() {
      els.btn.disabled = true;
      els.loading.style.display = "block";
      els.error.style.display = "none";
      els.result.innerHTML = "";
      els.progress.textContent = "0/15";
      els.progress.style.display = "inline-block";

      const prompt = els.prompt.value?.trim() || "";

      try {
        const encoded = files.length
          ? await Promise.all(files.map(async f => ({ b64: await toBase64(f), type: f.type })))
          : [];

        const N = 15;
        let done = 0;

        const tasks = Array.from({ length: N }, async () => {
          const seed = Math.floor(Math.random() * 1e9);
          const body = buildRequestBody({ prompt, encodedFiles: encoded, seed });
          const imgs = await callGemini(body);
          done++;
          els.progress.textContent = `${done}/${N}`;
          return imgs;
        });

        const settled = await Promise.allSettled(tasks);
        const gallery = [];

        for (const s of settled) {
          if (s.status === "fulfilled" && s.value?.length) {
            gallery.push(s.value[0]);
          }
        }

        if (!gallery.length) {
          els.error.textContent = "No image generated for this prompt.";
          els.error.style.display = "block";
          return;
        }

        const frag = document.createDocumentFragment();
        gallery.forEach(imgObj => {
          const img = document.createElement("img");
          img.alt = "Generated image";
          img.src = `data:${imgObj.mime};base64,${imgObj.b64}`;
          frag.appendChild(img);
        });
        els.result.appendChild(frag);

        if (gallery.length < N) {
          els.error.textContent = `Generated ${gallery.length}/${N} due to API errors on some attempts.`;
          els.error.style.display = "block";
        }
      } catch (err) {
        console.error(err);
        els.error.textContent = `Error: ${err.message || "Unknown error"}`;
        els.error.style.display = "block";
      } finally {
        els.loading.style.display = "none";
        els.btn.disabled = false;
        els.progress.style.display = "none";
      }
    }
  </script>
</body>
</html>
